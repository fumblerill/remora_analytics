{% extends "base.html" %}
{% block title %}–ê–Ω–∞–ª–∏–∑ –≤—ã–≥—Ä—É–∑–∫–∏ –°–≠–ú–î{% endblock %}

{% block content %}

{% if filename %}
<div id="preloader" class="d-flex justify-content-center align-items-center" style="height: 80vh;">
  <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
  </div>
</div>
{% endif %}

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if not filename %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <h2 class="text-primary text-center">–ó–∞–≥—Ä—É–∑–∏—Ç–µ .xlsx —Ñ–∞–π–ª, –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h2> 
</div>
{% endif %}

{% if filename %}
<div id="content-wrapper" style="display: none; opacity: 0; transition: opacity 0.3s;">
  <h2 class="mb-4">–ê–Ω–∞–ª–∏–∑ –≤—ã–≥—Ä—É–∑–∫–∏ –°–≠–ú–î</h2>

  <!-- ======== –°–≠–ú–î –≤ –†–≠–ú–î | –í—Ä–∞—á–∏ > 500 ======== -->
  <div class="row mb-4">
    <div class="col-md-6" id="statistics">
      <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –°–≠–ú–î –≤ –†–≠–ú–î</h5>
        {{ tables.statistics | safe }}
    </div>

    <div class="col-md-6" id="doc_perf_500">
      <h5>üë®‚Äç‚öïÔ∏è –í—Ä–∞—á–∏, –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–µ > 500 –°–≠–ú–î</h5>
        {{ tables.doc_perf_500 | safe }}
    </div>
  </div>

  <!-- ======== –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ======== -->
  <div class="section mb-4" id="pie">
    <h5>üü£ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –°–≠–ú–î –≤ –†–≠–ú–î</h5>
    <div class="d-flex justify-content-center">
      <div style="width: 100%; max-width: 800px; display: flex; align-items: center;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ======== –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ======== -->
  <div class="section mb-5" id="bar">
    <h5>üìâ –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ‚Äî –û—à–∏–±–∫–∏ –°–≠–ú–î –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –†–≠–ú–î</h5>
    <div class="d-flex justify-content-center">
      <div style="width: 100%; max-width: 900px; height: 500px; display: flex; justify-content: center; margin-top: 40px; margin-bottom: 40px;">
        <canvas id="barChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ======== –í–∏–¥—ã –°–≠–ú–î | –û—à–∏–±–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ ======== -->
  <div class="row mb-4">
    <div class="col-md-6" id="types">
      <h5>üìë –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∏–¥–∞–º –°–≠–ú–î</h5>
        {{ tables.types | safe }}
    </div>

    <div class="col-md-6" id="cert_errors">
      <h5>üîê –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h5>
        {{ tables.cert_errors | safe }}
    </div>
  </div>

<!-- ======== –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å–∫—Ä—ã—Ç—ã) ======== -->
<div class="section mb-4" id="raw">
  <h5>üìã –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
  {% if tables and tables.raw %}
    <details>
      <summary class="mb-2 btn btn-outline-primary">üìÇ –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</summary>
        {{ tables.raw | safe }}
    </details>
  {% else %}
    <p><em>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</em></p>
  {% endif %}
</div>

  <!-- ======== –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—à–∏–±–æ–∫ (—Å–∫—Ä—ã—Ç) ======== -->
  <div class="section mb-4" id="reference">
    <h5>üìñ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—à–∏–±–æ–∫</h5>
      <details>
        <summary class="mb-2 btn btn-outline-secondary">üîç –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</summary>
          {{ tables.reference | safe }}
      </details>
  </div>
</div>
{% endif %}

{% block scripts %}
<!-- –°–∫—Ä–∏–ø—Ç—ã –∏ —Å—Ç–∏–ª–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- –¢–≤–æ–π —Å–∫—Ä–∏–ø—Ç -->
<script src="{{ url_for('static', path='js/upload.js') }}"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–±–ª–æ–Ω–∞
const barLabels = {{ bar_labels | default([]) | tojson }};
const barValues = {{ bar_values | default([]) | tojson }};
const pieLabels = {{ pie_labels | default([]) | tojson }};
const pieValues = {{ pie_values | default([]) | tojson }};

// –¶–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ (Set1 –ø–∞–ª–∏—Ç—Ä–∞ ColorBrewer)
const backgroundColors = [
  '#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00',
  '#ffff33', '#a65628', '#f781bf', '#999999', '#66c2a5', '#fc8d62'
];
const barColors = barLabels.map((_, i) => backgroundColors[i % backgroundColors.length]);

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è, –ª–µ–≥–µ–Ω–¥–∞ —Å–ø—Ä–∞–≤–∞)
const ctxBar = document.getElementById('barChart').getContext('2d');

if (window.barChartInstance) {
  window.barChartInstance.destroy();
}

window.barChartInstance = new Chart(ctxBar, {
  type: 'bar',
  data: {
    labels: barLabels,
    datasets: [{
      data: barValues,
      backgroundColor: barColors,
      borderRadius: 4,
      borderWidth: 1
    }]
  },
  options: {
    indexAxis: 'x', // –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
    responsive: true,
    plugins: {
      legend: {
        display: true,
        position: 'right',
        labels: {
          generateLabels: (chart) => chart.data.labels.map((label, i) => ({
            text: label,
            fillStyle: barColors[i],
            strokeStyle: barColors[i],
            index: i
          }))
        }
      },
      datalabels: {
        display: false // –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö
      }
    },
    scales: {
      x: {
        beginAtZero: false,
        ticks: {
          display: false // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –ø–æ–¥ —Å—Ç–æ–ª–±—Ü–∞–º–∏ (–æ—Å–∏ X)
        },
        grid: {
          display: false
        }
      },
      y: {
        beginAtZero: true,
        ticks: { precision: 0 }
      }
    }
  },
  plugins: [ChartDataLabels]
});

// –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
const ctxPie = document.getElementById('pieChart').getContext('2d');

if (window.pieChartInstance) {
  window.pieChartInstance.destroy();
}

window.pieChartInstance = new Chart(ctxPie, {
  type: 'pie',
  data: {
    labels: pieLabels,
    datasets: [{
      data: pieValues,
      backgroundColor: backgroundColors.slice(0, pieValues.length)
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: { padding: { top: 20, bottom: 20 } },
    plugins: {
      legend: {
        position: 'right',
        labels: { padding: 20 }
      },
      datalabels: {
        color: '#000',
        font: { weight: 'bold' },
        formatter: (value, context) => {
          const data = context.chart.data.datasets[0].data;
          const total = data.reduce((a, b) => a + b, 0);
          return ((value / total) * 100).toFixed(1) + '%';
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});
</script>
{% endblock %}
{% endblock %}